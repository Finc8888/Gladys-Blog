events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    # MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for" '
                   'rt=$request_time uct="$upstream_connect_time" '
                   'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 100;
    types_hash_max_size 2048;
    server_tokens off;

    # Client settings
    client_max_body_size 16M;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 10240;
    gzip_proxied expired no-cache no-store private must-revalidate auth;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        text/json
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;

    # Security headers map
    map $sent_http_content_type $csp_header {
        default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self';";
    }

    # SSL Configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_ecdh_curve secp384r1;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # DH Parameters for additional security
    ssl_dhparam /etc/ssl/certs/dhparam.pem;

    # HTTP to HTTPS redirect server
    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }

    # HTTPS server
    server {
        listen 443 ssl http2;
        server_name _;
        root /usr/share/nginx/html;
        index index.html index.htm;

        # SSL Certificate paths (adjust for your domain)
        ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem;
        ssl_trusted_certificate /etc/letsencrypt/live/YOUR_DOMAIN/chain.pem;

        # Rate limiting
        limit_req zone=general burst=20 nodelay;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy $csp_header always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Robots-Tag "index, follow" always;
        add_header Expect-CT "max-age=86400, enforce" always;

        # Main location
        location / {
            try_files $uri $uri/ $uri.html /index.html;
            
            # Cache static files
            location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
                add_header X-Content-Type-Options "nosniff";
                access_log off;
                
                # Enable CORS for fonts
                if ($request_method = 'GET') {
                    add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                }
            }

            # HTML files - short cache
            location ~* \.html$ {
                expires 10m;
                add_header Cache-Control "public, must-revalidate, proxy-revalidate";
            }

            # XML files (sitemap, RSS)
            location ~* \.(xml|rss)$ {
                expires 1h;
                add_header Cache-Control "public";
            }

            # JSON files
            location ~* \.json$ {
                expires 10m;
                add_header Cache-Control "public";
            }
        }

        # Blog posts with proper caching
        location /posts/ {
            try_files $uri $uri/ $uri.html /index.html;
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
        }

        # Tags and categories
        location ~ ^/(tags|categories)/ {
            try_files $uri $uri/ $uri.html /index.html;
            expires 30m;
            add_header Cache-Control "public, must-revalidate";
        }

        # Let's Encrypt ACME challenge
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
            try_files $uri =404;
        }

        # Health check endpoint
        location /health {
            access_log off;
            default_type text/plain;
            return 200 "healthy\nversion: 1.0\nstatus: ok\ntimestamp: $time_iso8601\nssl: enabled\n";
        }

        # Status endpoint for monitoring
        location /status {
            access_log off;
            default_type application/json;
            return 200 '{"status":"ok","service":"gladys-blog","timestamp":"$time_iso8601","version":"1.0","ssl":true}';
        }

        # Nginx status (for internal monitoring)
        location /nginx-status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow 10.0.0.0/8;
            allow 172.16.0.0/12;
            allow 192.168.0.0/16;
            deny all;
        }

        # Robots.txt
        location = /robots.txt {
            access_log off;
            log_not_found off;
            expires 7d;
        }

        # Favicon
        location = /favicon.ico {
            access_log off;
            log_not_found off;
            expires 30d;
        }

        # Block access to hidden files
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to backup files
        location ~ ~$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to WordPress/PHP files
        location ~* \.(php|asp|aspx|jsp|cgi|pl)$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block common attack vectors
        location ~* (wp-|wordpress|admin|login|xmlrpc|wp-json) {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Custom 404 page
        error_page 404 /404.html;
        location = /404.html {
            internal;
            expires 10m;
        }

        # Custom 50x pages
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
            root /usr/share/nginx/html;
        }

        # Compression test endpoint
        location = /compression-test {
            access_log off;
            default_type text/plain;
            return 200 "This is a compression test. If you can see this message and it's compressed, gzip is working correctly. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.";
        }
    }
}